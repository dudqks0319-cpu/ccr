<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜„ëŒ€ìë™ì°¨ CCR ê·¼ë¬´í‘œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            background: #f5f5f5;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 0;
            }

            body {
                background: white;
            }

            #print-area {
                zoom: 0.62 !important;
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 8px !important;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .calendar-container {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            .calendar-day {
                min-height: 155px !important;
                height: auto !important;
                padding: 4px 3px !important;
                font-size: 10px !important;
                /* Base shrink */
            }

            .day-worker-info {
                font-size: 10.5px !important;
            }

            .night-c-info {
                font-size: 10px !important;
            }

            .print-title {
                padding-top: 3px !important;
                padding-bottom: 3px !important;
                margin-bottom: 3px !important;
                font-size: 20px !important;
                /* Slightly smaller */
                border-bottom: 1px solid #003D82 !important;
            }

            .memo-area {
                margin-top: 5px !important;
                padding: 5px !important;
            }

            .memo-area textarea {
                border: 1px solid #eee !important;
                height: auto !important;
                min-height: 40px !important;
                font-size: 10px !important;
            }
        }

        .print-only-title {
            display: none;
        }

        @media print {
            .print-only-title {
                display: block !important;
            }
        }

        /* Toast Animation */
        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .animate-toast {
            animation: slideUp 0.3s ease-out;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const TEAMS = {
            'ì»¨ë² ì–´': ['í˜¸ë¹ˆ', 'ë¯¼ì„±', 'ë™ì¸', 'ì„ ìš°', 'ìœ¤ìˆ˜'],
            'ë¡œë³´íŠ¸': ['ê´‘ìˆ˜', 'ì˜ë¹ˆ', 'ì„œìš©', 'ì°¬ìš°', 'ì„±ê´‘'],
            'ì£¼ì„¤ë¹„': ['ìš°ìš©', 'ì¬ë ¹', 'ë¯¼í˜', 'ì´ì§„', 'ì„±ìš´', 'ìŠ¹í˜„']
        };

        const NIGHT_TEAMS = {
            'AíŒ€': ['ë¯¼ì„±', 'ê´‘ìˆ˜', 'ì´ì§„'],
            'BíŒ€': ['í˜¸ë¹ˆ', 'ì°¬ìš°', 'ì„±ìš´'],
            'CíŒ€': ['ì„ ìš°', 'ì„œìš©', 'ìš°ìš©'],
            'DíŒ€': ['ë™ì¸', 'ì˜ë¹ˆ', 'ë¯¼í˜'],
            'EíŒ€': ['ìœ¤ìˆ˜', 'ì„±ê´‘', 'ì¬ë ¹']
        };

        function App() {
            // LocalStorageì—ì„œ ì´ˆê¸°ê°’ ë¡œë“œ
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : defaultValue;
                } catch {
                    return defaultValue;
                }
            };

            const [year, setYear] = useState(() => loadFromStorage('ccr_year', 2025));
            const [month, setMonth] = useState(() => loadFromStorage('ccr_month', 11));
            const [selectedNightTeam, setSelectedNightTeam] = useState(() => loadFromStorage('ccr_nightTeam', 'AíŒ€'));
            const [showSettings, setShowSettings] = useState(false);
            const [selectedDay, setSelectedDay] = useState(null);
            const [viewMode, setViewMode] = useState('month');
            const [offDays, setOffDays] = useState(() => loadFromStorage('ccr_offDays', []));
            const [overrides, setOverrides] = useState(() => loadFromStorage('ccr_overrides', {}));
            const [startWithNight, setStartWithNight] = useState(() => loadFromStorage('ccr_startWithNight', false));
            const [teams, setTeams] = useState(() => loadFromStorage('ccr_teams', TEAMS));
            const [nightTeams, setNightTeams] = useState(() => loadFromStorage('ccr_nightTeams', NIGHT_TEAMS));
            const [memo, setMemo] = useState(() => loadFromStorage('ccr_memo', ''));
            const [darkMode, setDarkMode] = useState(() => loadFromStorage('ccr_darkMode', false));
            const [showStats, setShowStats] = useState(false);
            const [comments, setComments] = useState(() => loadFromStorage('ccr_comments', {}));
            const [sealerRotationDate, setSealerRotationDate] = useState(() => loadFromStorage('ccr_sealerDate', '2025-01-05'));
            const [toasts, setToasts] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const sealerTeams = ['ì»¨ë² ì–´íŒ€', 'ë¡œë³´íŠ¸íŒ€', 'ì£¼ì„¤ë¹„íŒ€'];

            // Phase 2-4 States
            const [vacations, setVacations] = useState(() => loadFromStorage('ccr_vacations', {}));
            const [themeColor, setThemeColor] = useState(() => loadFromStorage('ccr_themeColor', '#003D82'));
            const [lang, setLang] = useState(() => loadFromStorage('ccr_lang', 'ko'));
            const [history, setHistory] = useState(() => loadFromStorage('ccr_history', []));
            const [showHistory, setShowHistory] = useState(false);
            const [touchStart, setTouchStart] = useState(null);
            // 8ë²ˆ: ì½ê¸°ì „ìš© ëª¨ë“œ
            const [isReadonly, setIsReadonly] = useState(false);
            // PDF ë°°ìœ¨ (ê¸°ë³¸ 95%)
            const [pdfScale, setPdfScale] = useState(95);
            // 7ë²ˆ: í† ìš”ì¼ ìƒì‚°íŠ¹ê·¼
            const [saturdayOvertime, setSaturdayOvertime] = useState(() => loadFromStorage('ccr_saturdayOvertime', {}));
            // 2ë²ˆ/6ë²ˆ: Cì¡° ê°œë³„ ì˜¤ë²„ë¼ì´ë“œ
            const [nightTeamOverrides, setNightTeamOverrides] = useState(() => loadFromStorage('ccr_nightTeamOverrides', {}));

            // Translations
            const T = {
                ko: { title: 'í˜„ëŒ€ìë™ì°¨ CCR ê·¼ë¬´í‘œ', stats: 'í†µê³„', settings: 'ì„¤ì •', prev: 'ì´ì „', next: 'ë‹¤ìŒ', am: 'ì „ë°˜', pm: 'í›„ë°˜', day: 'ì£¼ê°„', night: 'ì•¼ê°„', vacation: 'íœ´ê°€', theme: 'í…Œë§ˆ', history: 'ë³€ê²½ ì´ë ¥', share: 'URL ê³µìœ ', copySuccess: 'URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', search: 'ê·¼ë¬´ì ê²€ìƒ‰...', memo: 'ë©”ëª¨', print: 'ì¸ì‡„', pdf: 'PDF', excel: 'ì—‘ì…€', import: 'ë¶ˆëŸ¬ì˜¤ê¸°' },
                en: { title: 'Hyundai CCR Schedule', stats: 'Stats', settings: 'Settings', prev: 'Prev', next: 'Next', am: 'AM', pm: 'PM', day: 'Day', night: 'Night', vacation: 'Vacation', theme: 'Theme', history: 'History', share: 'Share URL', copySuccess: 'URL Copied!', search: 'Search worker...', memo: 'Memo', print: 'Print', pdf: 'PDF', excel: 'Excel', import: 'Import' }
            };
            const t = T[lang];

            // Add to history
            const addHistory = (action) => {
                const entry = { time: new Date().toISOString(), action };
                setHistory(prev => [entry, ...prev].slice(0, 50));
            };

            // URL Sharing - 8ë²ˆ: ì½ê¸°ì „ìš© ì˜µì…˜ ì¶”ê°€
            const shareURL = (readonly = false) => {
                const state = { year, month, selectedNightTeam, startWithNight, themeColor, readonly };
                const encoded = btoa(JSON.stringify(state));
                // file:// í”„ë¡œí† ì½œ í˜¸í™˜ì„±ì„ ìœ„í•´ href ì‚¬ìš©
                const textToCopy = `${window.location.href.split('?')[0]}?state=${encoded}`;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast(readonly ? 'ğŸ”’ ì½ê¸°ì „ìš© ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ğŸ”— ê³µìœ  ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    alert("âš ï¸ ì£¼ì˜: ì´ ì£¼ì†ŒëŠ” 'ë‚´ ì»´í“¨í„°'ì— ìˆëŠ” íŒŒì¼ ì£¼ì†Œì…ë‹ˆë‹¤.\n\në‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ê³µìœ í•˜ë ¤ë©´,\n1. ì´ 'íŒŒì¼' ìì²´ë¥¼ ì¹´í†¡ìœ¼ë¡œ ë¨¼ì € ë³´ë‚´ê³ \n2. ë°›ì€ ì‚¬ëŒì´ íŒŒì¼ì„ ì—° ë’¤ì— ì´ ì£¼ì†Œë¥¼ ë¶™ì—¬ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.");
                }).catch(err => {
                    showToast('ì£¼ì†Œ ë³µì‚¬ ì‹¤íŒ¨: ' + err);
                });
            };

            // 9ë²ˆ: ICS ìº˜ë¦°ë” íŒŒì¼ ë‚´ë³´ë‚´ê¸°
            const exportICS = () => {
                let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CCR Schedule//KO
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
                calendar.days.forEach(day => {
                    if (day.am !== 'OFF') {
                        const dateStr = `${year}${String(month + 1).padStart(2, '0')}${String(day.d).padStart(2, '0')}`;
                        icsContent += `BEGIN:VEVENT
DTSTART:${dateStr}T080000
DTEND:${dateStr}T120000
SUMMARY:CCR ì „ë°˜ - ${day.am}
DESCRIPTION:ì „ë°˜ ê·¼ë¬´: ${day.am}\\ní›„ë°˜ ê·¼ë¬´: ${day.pm}
END:VEVENT
`;
                    }
                });
                icsContent += 'END:VCALENDAR';

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CCR_${year}_${month + 1}ì›”.ics`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('ìº˜ë¦°ë” íŒŒì¼ ë‹¤ìš´ë¡œë“œë¨! ìº˜ë¦°ë” ì•±ì—ì„œ ì—´ê¸°');
            };

            // Load from URL on mount
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const stateParam = params.get('state');
                if (stateParam) {
                    try {
                        const decoded = JSON.parse(atob(stateParam));
                        if (decoded.year) setYear(decoded.year);
                        if (decoded.month !== undefined) setMonth(decoded.month);
                        if (decoded.selectedNightTeam) setSelectedNightTeam(decoded.selectedNightTeam);
                        if (decoded.startWithNight !== undefined) setStartWithNight(decoded.startWithNight);
                        if (decoded.themeColor) setThemeColor(decoded.themeColor);
                        if (decoded.readonly) setIsReadonly(true);
                    } catch (e) { console.log('Invalid state param'); }
                }
            }, []);

            // Touch swipe for mobile
            const handleTouchStart = (e) => setTouchStart(e.touches[0].clientX);
            const handleTouchEnd = (e) => {
                if (!touchStart) return;
                const diff = touchStart - e.changedTouches[0].clientX;
                if (diff > 50) nextMonth();
                else if (diff < -50) prevMonth();
                setTouchStart(null);
            };

            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            };

            // LocalStorageì— ìë™ ì €ì¥
            useEffect(() => {
                localStorage.setItem('ccr_year', JSON.stringify(year));
            }, [year]);

            useEffect(() => {
                localStorage.setItem('ccr_month', JSON.stringify(month));
            }, [month]);

            useEffect(() => {
                localStorage.setItem('ccr_nightTeam', JSON.stringify(selectedNightTeam));
            }, [selectedNightTeam]);

            useEffect(() => {
                localStorage.setItem('ccr_offDays', JSON.stringify(offDays));
            }, [offDays]);

            useEffect(() => {
                localStorage.setItem('ccr_overrides', JSON.stringify(overrides));
            }, [overrides]);

            useEffect(() => {
                localStorage.setItem('ccr_startWithNight', JSON.stringify(startWithNight));
            }, [startWithNight]);

            useEffect(() => {
                localStorage.setItem('ccr_teams', JSON.stringify(teams));
            }, [teams]);

            useEffect(() => {
                localStorage.setItem('ccr_nightTeams', JSON.stringify(nightTeams));
            }, [nightTeams]);

            useEffect(() => {
                localStorage.setItem('ccr_memo', JSON.stringify(memo));
            }, [memo]);

            useEffect(() => {
                localStorage.setItem('ccr_darkMode', JSON.stringify(darkMode));
            }, [darkMode]);

            useEffect(() => {
                localStorage.setItem('ccr_sealerDate', JSON.stringify(sealerRotationDate));
            }, [sealerRotationDate]);

            useEffect(() => {
                localStorage.setItem('ccr_comments', JSON.stringify(comments));
            }, [comments]);

            useEffect(() => {
                localStorage.setItem('ccr_vacations', JSON.stringify(vacations));
            }, [vacations]);

            useEffect(() => {
                localStorage.setItem('ccr_themeColor', JSON.stringify(themeColor));
            }, [themeColor]);

            useEffect(() => {
                localStorage.setItem('ccr_lang', JSON.stringify(lang));
            }, [lang]);

            useEffect(() => {
                localStorage.setItem('ccr_history', JSON.stringify(history));
            }, [history]);

            useEffect(() => {
                localStorage.setItem('ccr_saturdayOvertime', JSON.stringify(saturdayOvertime));
            }, [saturdayOvertime]);

            useEffect(() => {
                localStorage.setItem('ccr_nightTeamOverrides', JSON.stringify(nightTeamOverrides));
            }, [nightTeamOverrides]);

            // ë‹¨ì¶•í‚¤ ì§€ì›
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    if (e.key === 'ArrowLeft') {
                        setMonth(prev => prev === 0 ? 11 : prev - 1);
                        if (month === 0) setYear(prev => prev - 1);
                    } else if (e.key === 'ArrowRight') {
                        setMonth(prev => prev === 11 ? 0 : prev + 1);
                        if (month === 11) setYear(prev => prev + 1);
                    } else if (e.key === 'Escape') {
                        setSelectedDay(null);
                        setShowSettings(false);
                        setShowStats(false);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [month, year]);

            // íŒ€ë³„ë¡œ í•œ ëª…ì”© êµì°¨ ë°°ì¹˜
            const allWorkers = [];
            const maxLength = Math.max(teams['ì»¨ë² ì–´'].length, teams['ë¡œë³´íŠ¸'].length, teams['ì£¼ì„¤ë¹„'].length);
            for (let i = 0; i < maxLength; i++) {
                if (teams['ì»¨ë² ì–´'][i]) allWorkers.push(teams['ì»¨ë² ì–´'][i]);
                if (teams['ë¡œë³´íŠ¸'][i]) allWorkers.push(teams['ë¡œë³´íŠ¸'][i]);
                if (teams['ì£¼ì„¤ë¹„'][i]) allWorkers.push(teams['ì£¼ì„¤ë¹„'][i]);
            }

            const calendar = useMemo(() => {
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const days = [];
                let workDay = 0;

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, month, d);
                    const dow = date.getDay();
                    const week = Math.floor((d + firstDay - 1) / 7);
                    const dateKey = `${year}-${month + 1}-${d}`;

                    let am, pm;
                    const isOffDay = offDays.includes(dateKey);

                    if (dow === 0 || isOffDay) {
                        am = pm = 'OFF';
                    } else if (overrides[dateKey]) {
                        am = overrides[dateKey].am;
                        pm = overrides[dateKey].pm;
                        workDay++;
                    } else {
                        am = allWorkers[workDay % allWorkers.length];
                        pm = allWorkers[(workDay + 1) % allWorkers.length];
                        workDay++;
                    }

                    // ì£¼ê°„/ì•¼ê°„ ê²°ì • (startWithNightì— ë”°ë¼ ë°˜ì „)
                    const isNightWeek = startWithNight ? (week % 2 === 0) : (week % 2 === 1);
                    days.push({ d, dow, am, pm, night: isNightWeek, week, dateKey, isOffDay });
                }

                return { days, firstDay };
            }, [year, month, offDays, overrides, startWithNight, teams]);

            const prevMonth = () => {
                if (month === 0) {
                    setMonth(11);
                    setYear(year - 1);
                } else {
                    setMonth(month - 1);
                }
            };

            const nextMonth = () => {
                if (month === 11) {
                    setMonth(0);
                    setYear(year + 1);
                } else {
                    setMonth(month + 1);
                }
            };

            const exportExcel = () => {
                const data = calendar.days.map(day => ({
                    'ë‚ ì§œ': `${year}-${month + 1}-${day.d}`,
                    'ìš”ì¼': ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][day.dow],
                    'ì „ë°˜': day.am,
                    'í›„ë°˜': day.pm,
                    'ì£¼ì•¼': day.night ? 'ì•¼ê°„' : 'ì£¼ê°„'
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ê·¼ë¬´í‘œ");
                XLSX.writeFile(wb, `CCRê·¼ë¬´í‘œ_${year}_${month + 1}ì›”.xlsx`);
            };

            const importExcel = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const data = new Uint8Array(evt.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            const newOverrides = {};
                            jsonData.forEach(row => {
                                if (row['ë‚ ì§œ'] && row['ì „ë°˜'] && row['í›„ë°˜']) {
                                    const dateKey = row['ë‚ ì§œ'];
                                    if (row['ì „ë°˜'] !== 'OFF' && row['í›„ë°˜'] !== 'OFF') {
                                        newOverrides[dateKey] = {
                                            am: row['ì „ë°˜'],
                                            pm: row['í›„ë°˜']
                                        };
                                    }
                                }
                            });

                            setOverrides(newOverrides);
                            showToast('ì—‘ì…€ íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                        } catch (error) {
                            showToast('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            console.error(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            };

            const getSealerTeam = (dateStr) => {
                const date = new Date(dateStr);
                const refDate = new Date(sealerRotationDate);
                // Set both to midnight to avoid time issues
                date.setHours(0, 0, 0, 0);
                refDate.setHours(0, 0, 0, 0);

                const diffTime = date.getTime() - refDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays < 0) return null;
                const cycleIndex = Math.floor(diffDays / 14) % 3;
                return sealerTeams[cycleIndex];
            };

            const exportPDF = async () => {
                try {
                    const calendarElement = document.getElementById('print-area');

                    const canvas = await html2canvas(calendarElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        windowWidth: 1400,
                        onclone: (clonedDoc) => {
                            // PDF ì €ì¥ ìµœì í™”
                            const days = clonedDoc.querySelectorAll('.calendar-day');
                            days.forEach(day => {
                                day.style.height = 'auto';
                                day.style.minHeight = '160px';
                                day.style.maxHeight = 'none';
                                day.style.overflow = 'visible';
                                day.style.fontSize = '8.5px';
                                day.style.padding = '2px 2px 4px 2px';
                                day.style.lineHeight = '1.1';
                            });

                            const elements = clonedDoc.querySelectorAll('.calendar-day div');
                            elements.forEach(el => {
                                el.style.marginBottom = '1px';
                                el.style.marginTop = '0px';
                                el.style.paddingTop = '0px';
                                el.style.paddingBottom = '0px';
                            });

                            const clonedTitle = clonedDoc.querySelector('.print-title');
                            if (clonedTitle) clonedTitle.style.display = 'block';

                            // ì‚¬ìš©ì ì„¤ì • ë°°ìœ¨ ì ìš© (ë‚´ìš©ì„ ì¶•ì†Œí•´ì„œ A4 í•œ ì¥ì— ë” ë§ì´ ë‹´ê¸° ìœ„í•¨)
                            const container = clonedDoc.getElementById('print-area');
                            if (container) {
                                const scale = pdfScale / 100;
                                container.style.transform = `scale(${scale})`;
                                container.style.transformOrigin = 'top left'; // ì™¼ìª½ ìœ„ ê¸°ì¤€ ì¶•ì†Œ
                                // í­ ë³´ì •: ë°°ìœ¨ì´ ì¤„ì–´ë“  ë§Œí¼ ê°€ë¡œ í­ì„ ë„“í˜€ì„œ A4 ê°€ë¡œë¥¼ ê½‰ ì±„ìš°ê²Œ í•¨
                                const widthPercent = 100 / scale;
                                container.style.width = `${widthPercent}%`;
                                // ë†’ì´ ë³´ì •ì€ ìë™
                            }
                        }
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('l', 'mm', 'a4'); // A4 ê°€ë¡œ (297mm x 210mm)

                    const pageWidth = 297;
                    const pageHeight = 210;

                    // ì›ë³¸ ë¹„ìœ¨ ê³„ì‚°
                    const originalImgWidth = pageWidth;
                    const originalImgHeight = (canvas.height * pageWidth) / canvas.width;

                    // ì‚¬ìš©ì ë°°ìœ¨ (ê¸°ë³¸ 95%)
                    const userScale = pdfScale / 100;

                    // ë‚´ìš©ì´ í˜ì´ì§€ ë†’ì´ë¥¼ ë„˜ìœ¼ë©´, í•œ í˜ì´ì§€ì— ë§ì¶”ê¸° ìœ„í•œ ì¶”ê°€ ì¶•ì†Œ ê³„ì‚°
                    let fitScale = 1;
                    if (originalImgHeight * userScale > pageHeight) {
                        // í˜ì´ì§€ ë†’ì´ì— ë§ì¶”ë ¤ë©´ ì–¼ë§ˆë‚˜ ë” ì¶•ì†Œí•´ì•¼ í•˜ëŠ”ì§€ ê³„ì‚°
                        fitScale = pageHeight / (originalImgHeight * userScale);
                    }

                    // ìµœì¢… ë°°ìœ¨ = ì‚¬ìš©ì ë°°ìœ¨ Ã— ë§ì¶¤ ë°°ìœ¨
                    const finalScale = userScale * fitScale;

                    const imgWidth = pageWidth * finalScale;
                    const imgHeight = originalImgHeight * finalScale;

                    // ì¤‘ì•™ ì •ë ¬
                    const xOffset = (pageWidth - imgWidth) / 2;
                    const yOffset = (pageHeight - imgHeight) / 2; // ì„¸ë¡œë„ ì¤‘ì•™ ì •ë ¬

                    // í•œ í˜ì´ì§€ì— ì¶œë ¥ (ë§ì¶°ì„œ ì¶•ì†Œí–ˆìœ¼ë¯€ë¡œ í•­ìƒ 1í˜ì´ì§€)
                    pdf.addImage(imgData, 'PNG', xOffset, yOffset > 0 ? yOffset : 0, imgWidth, imgHeight);

                    pdf.save(`CCRê·¼ë¬´í‘œ_${year}_${month + 1}ì›”.pdf`);
                    showToast(`PDF ì €ì¥ ì™„ë£Œ! (ë°°ìœ¨: ${Math.round(finalScale * 100)}%)`);
                } catch (error) {
                    showToast('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error(error);
                }
            };

            // ê·¼ë¬´ í†µê³„ ê³„ì‚°
            const calculateStats = useMemo(() => {
                const stats = {};
                allWorkers.forEach(worker => {
                    stats[worker] = { total: 0, am: 0, pm: 0, dayShift: 0, nightShift: 0 };
                });

                calendar.days.forEach(day => {
                    if (day.am !== 'OFF' && stats[day.am]) {
                        stats[day.am].total++;
                        stats[day.am].am++;
                        if (day.night) stats[day.am].nightShift++;
                        else stats[day.am].dayShift++;
                    }
                    if (day.pm !== 'OFF' && stats[day.pm]) {
                        stats[day.pm].total++;
                        stats[day.pm].pm++;
                        if (day.night) stats[day.pm].nightShift++;
                        else stats[day.pm].dayShift++;
                    }
                });

                return stats;
            }, [calendar, allWorkers]);

            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

            // ì—°ë„ ë³´ê¸°ìš© - íŠ¹ì • ì›”ì˜ ë¯¸ë‹ˆ ìº˜ë¦°ë” ìƒì„±
            const generateMiniCalendar = (y, m) => {
                const daysInMonth = new Date(y, m + 1, 0).getDate();
                const firstDay = new Date(y, m, 1).getDay();
                const days = [];
                let workDay = 0;

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(y, m, d);
                    const dow = date.getDay();
                    const week = Math.floor((d + firstDay - 1) / 7);
                    const dateKey = `${y}-${m + 1}-${d}`;

                    let am, pm;
                    const isOffDay = offDays.includes(dateKey);

                    if (dow === 0 || isOffDay) {
                        am = pm = 'OFF';
                    } else if (overrides[dateKey]) {
                        am = overrides[dateKey].am;
                        pm = overrides[dateKey].pm;
                        workDay++;
                    } else {
                        am = allWorkers[workDay % allWorkers.length];
                        pm = allWorkers[(workDay + 1) % allWorkers.length];
                        workDay++;
                    }

                    // ì£¼ê°„/ì•¼ê°„ ê²°ì • (startWithNightì— ë”°ë¼ ë°˜ì „)
                    const isNightWeek = startWithNight ? (week % 2 === 0) : (week % 2 === 1);
                    days.push({ d, dow, am, pm, night: isNightWeek, week, dateKey, isOffDay });
                }

                return { days, firstDay };
            };

            return (
                <div
                    className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-[#f5f5f5]'}`}
                    onTouchStart={handleTouchStart}
                    onTouchEnd={handleTouchEnd}
                >
                    {/* Header */}
                    <div style={{ backgroundColor: themeColor }} className="text-white p-4 flex justify-between items-center no-print flex-wrap gap-2">
                        <div className="flex items-center gap-3">
                            <h1 className="text-2xl font-bold">í˜„ëŒ€ìë™ì°¨ CCR ê·¼ë¬´í‘œ</h1>
                            {isReadonly && (
                                <span className="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-bold animate-pulse">
                                    ğŸ‘ï¸ ì½ê¸°ì „ìš©
                                </span>
                            )}
                        </div>
                        <div className="flex flex-wrap gap-2 items-center">
                            {/* ê·¼ë¬´ì ê²€ìƒ‰ */}
                            <div className="relative group no-print">
                                <span className="absolute left-3 top-2.5 text-gray-300">ğŸ”</span>
                                <input
                                    type="text"
                                    placeholder={t.search}
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="pl-10 pr-4 py-2 rounded-lg bg-white/20 text-white placeholder-gray-300 border border-white/30 focus:ring-2 focus:ring-cyan-400 outline-none w-40 transition-all focus:w-56"
                                />
                                {searchTerm && (
                                    <button onClick={() => setSearchTerm('')} className="absolute right-3 top-2.5 text-gray-300 hover:text-white">âœ•</button>
                                )}
                            </div>

                            <div className="relative group">
                                <button onClick={() => shareURL(false)} className="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg font-bold text-sm">
                                    ğŸ”— URL ê³µìœ 
                                </button>
                                <button onClick={() => { setIsReadonly(!isReadonly); shareURL(!isReadonly); }} className={`${isReadonly ? 'bg-yellow-400 text-yellow-900' : 'bg-yellow-500 hover:bg-yellow-600'} px-3 py-2 rounded-lg font-bold text-sm ml-1`} title="ì½ê¸°ì „ìš© ëª¨ë“œ í† ê¸€">
                                    {isReadonly ? 'âœï¸ í¸ì§‘ëª¨ë“œ' : 'ğŸ‘ï¸ ì½ê¸°ì „ìš©'}
                                </button>
                            </div>
                            <button onClick={exportICS} className="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg font-bold text-sm">
                                ğŸ“… ìº˜ë¦°ë”
                            </button>
                            <button onClick={() => setShowHistory(true)} className="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg font-bold text-sm">
                                ğŸ“œ ë³€ê²½ì´ë ¥
                            </button>
                            <button onClick={() => setShowStats(true)} className="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-bold">
                                ğŸ“Š í†µê³„
                            </button>
                            <button onClick={() => setDarkMode(!darkMode)} className="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-bold">
                                {darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                            </button>
                            {!isReadonly && (
                                <button onClick={() => setShowSettings(true)} className="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-lg font-bold">
                                    âš™ï¸ ì„¤ì •
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Controls */}
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-4 shadow no-print`}>
                        <div className="max-w-7xl mx-auto flex flex-wrap gap-4 items-center justify-between">
                            <button onClick={prevMonth} className="bg-[#003D82] text-white px-6 py-2 rounded-lg font-bold">
                                â—€ ì´ì „
                            </button>

                            <div
                                onClick={() => setViewMode(viewMode === 'month' ? 'year' : 'month')}
                                className={`text-2xl font-bold border-2 border-gray-300 px-8 py-2 rounded-lg cursor-pointer hover:bg-gray-100 transition ${darkMode ? 'text-white bg-gray-700' : ''}`}
                            >
                                {viewMode === 'month' ? `${year}ë…„ ${monthNames[month]}` : `${year}ë…„`}
                            </div>

                            <button onClick={nextMonth} className="bg-[#003D82] text-white px-6 py-2 rounded-lg font-bold">
                                ë‹¤ìŒ â–¶
                            </button>
                        </div>

                        <div className="max-w-7xl mx-auto mt-4 flex flex-wrap gap-4 items-center">
                            <div className="flex items-center gap-2">
                                <span className={`font-bold ${darkMode ? 'text-white' : ''}`}>Cì¡°:</span>
                                <select
                                    value={selectedNightTeam}
                                    onChange={(e) => setSelectedNightTeam(e.target.value)}
                                    className="border-2 border-gray-300 px-4 py-2 rounded-lg"
                                >
                                    {Object.keys(nightTeams).map(team => (
                                        <option key={team} value={team}>
                                            {team} ({nightTeams[team].join(', ')})
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <span className={`font-bold ${darkMode ? 'text-white' : ''}`}>ì‹œì‘:</span>
                                <button
                                    onClick={() => setStartWithNight(!startWithNight)}
                                    className={`${startWithNight ? 'bg-blue-900 text-white' : 'bg-yellow-400'} hover:opacity-80 px-6 py-2 rounded-lg font-bold transition`}
                                >
                                    {startWithNight ? 'ğŸŒ™ ì•¼ê°„' : 'â˜€ï¸ ì£¼ê°„'}
                                </button>
                            </div>

                            <div className="flex items-center gap-1 bg-white/50 p-1 rounded-lg">
                                <span className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-700'}`}>ì¸ì‡„ë°°ìœ¨:</span>
                                <input
                                    type="number"
                                    min="50"
                                    max="150"
                                    value={pdfScale}
                                    onChange={(e) => setPdfScale(Number(e.target.value))}
                                    className="w-16 px-2 py-1 rounded border text-center text-sm"
                                />
                                <span className={`text-xs ${darkMode ? 'text-white' : 'text-gray-700'}`}>%</span>
                            </div>

                            <button
                                onClick={exportExcel}
                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2"
                            >
                                ğŸ“¤ ì—‘ì…€
                            </button>

                            <button
                                onClick={importExcel}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold"
                            >
                                ğŸ“¤ ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>

                            <button
                                onClick={exportPDF}
                                className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold"
                            >
                                ğŸ“„ PDF
                            </button>

                            <button
                                onClick={() => window.print()}
                                className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-bold"
                            >
                                ğŸ–¨ï¸ ì¸ì‡„
                            </button>
                        </div>
                    </div>

                    {/* Main Content Area (Printed) */}
                    <div id="print-area" className="bg-white">
                        {/* Print Only Title */}
                        <div className="hidden print-only-title text-3xl font-bold text-center py-8 text-[#003D82] border-b-2 border-[#003D82] mb-6 print-title">
                            í˜„ëŒ€ìë™ì°¨ CCR ê·¼ë¬´í‘œ ({year}ë…„ {monthNames[month]})
                        </div>

                        {/* Calendar */}
                        <div className="max-w-7xl mx-auto p-4">
                            {viewMode === 'month' ? (
                                // ì›”ë³„ ìƒì„¸ ë³´ê¸°
                                <div className="bg-white rounded-lg shadow-lg overflow-hidden calendar-container">
                                    {/* Day headers */}
                                    <div className="grid grid-cols-7 bg-[#003D82] text-white">
                                        {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((n, i) => (
                                            <div key={i} className={`text-center font-bold p-3 text-lg ${i === 0 ? 'text-red-300' : ''}`}>
                                                {n}
                                            </div>
                                        ))}
                                    </div>

                                    {/* Calendar days */}
                                    <div className="grid grid-cols-7 gap-px bg-gray-200">
                                        {Array(calendar.firstDay).fill(0).map((_, i) => (
                                            <div key={'e' + i} className="bg-gray-100 min-h-32 calendar-day"></div>
                                        ))}
                                        {calendar.days.map((day) => {
                                            const isNight = day.night;
                                            const isSunday = day.dow === 0;
                                            const bgColor = isNight ? 'bg-[#1e3a5f] text-white' : 'bg-white';

                                            // ê²€ìƒ‰ ê°•ì¡° ë¡œì§
                                            const isHighlighted = searchTerm && (
                                                (day.am === searchTerm) ||
                                                (day.pm === searchTerm) ||
                                                (isNight && nightTeams[selectedNightTeam].includes(searchTerm)) ||
                                                (comments[day.dateKey]?.includes(searchTerm))
                                            );

                                            return (
                                                <div
                                                    key={day.d}
                                                    onClick={() => !isReadonly && setSelectedDay(day)}
                                                    style={(isSunday || day.isOffDay) ? { backgroundColor: '#fca5a5', color: '#7f1d1d' } : {}}
                                                    className={`${(isSunday || day.isOffDay) ? '' : bgColor} p-3 min-h-32 relative cursor-pointer hover:opacity-80 transition calendar-day ${isHighlighted ? 'ring-4 ring-yellow-400 z-10 shadow-xl' : ''}`}
                                                >
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <div className={`font-bold text-lg ${isSunday && !isNight ? 'text-red-500' : ''} ${day.dow === 6 && !isNight ? 'text-blue-500' : ''}`}>
                                                                {day.d}
                                                            </div>
                                                            {/* 7ë²ˆ: í† ìš”ì¼ íŠ¹ê·¼ ë°°ì§€ */}
                                                            {day.dow === 6 && saturdayOvertime[day.dateKey] && (
                                                                <span className="text-[9px] bg-orange-500 text-white px-1 py-0.5 rounded font-bold">íŠ¹ê·¼</span>
                                                            )}
                                                        </div>
                                                        {getSealerTeam(day.dateKey) && (
                                                            <div className="text-[10px] text-purple-600 font-bold bg-purple-50 px-1.5 py-0.5 rounded border border-purple-200 italic shadow-sm whitespace-nowrap">
                                                                âš ï¸ ì•ˆì°©ë¶ˆëŸ‰({getSealerTeam(day.dateKey)})
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* ì£¼ê°„/ì•¼ê°„ í‘œì‹œ */}
                                                    {!isSunday && (
                                                        <div className="text-xs mb-2">
                                                            {isNight ? 'ğŸŒ™ ì•¼ê°„' : 'â˜€ï¸ ì£¼ê°„'}
                                                        </div>
                                                    )}

                                                    {/* ê·¼ë¬´ì */}
                                                    <div className="space-y-1 text-sm day-worker-info">
                                                        <div className={isNight ? 'text-yellow-200' : 'text-blue-700'}>
                                                            <span className="font-semibold text-[0.95em]">ì „ë°˜: {day.am}</span>
                                                        </div>
                                                        <div className={isNight ? 'text-green-300' : 'text-green-600'}>
                                                            <span className="font-semibold text-[0.95em]">í›„ë°˜: {day.pm}</span>
                                                        </div>
                                                    </div>

                                                    {/* Cì¡° í‘œì‹œ (ì•¼ê°„ ì£¼ ì „ì²´) - 2ë²ˆ/6ë²ˆ: ê°œë³„ ì˜¤ë²„ë¼ì´ë“œ ì§€ì› */}
                                                    {isNight && (
                                                        <div className="mt-2 pt-1 border-t border-gray-500 text-xs text-cyan-300 night-c-info">
                                                            <div className="font-semibold scale-95 origin-left">
                                                                {isSunday ? 'ì¡°ê¸°ê°€ë™' : 'Cì¡°'}: {nightTeamOverrides[day.dateKey] || nightTeams[selectedNightTeam].join(', ')}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* ë‚´íŒì‹¤ëŸ¬ ì•ˆì°©ë¶ˆëŸ‰ ì¡°ì¹˜íŒ€ í‘œì‹œ - ìƒë‹¨ìœ¼ë¡œ ì´ë™ë¨ */}

                                                    {/* ì½”ë©˜íŠ¸ í‘œì‹œ */}
                                                    {comments[day.dateKey] && (
                                                        <div className="mt-1 text-xs text-red-600 font-bold bg-yellow-100 px-1 rounded truncate shadow-sm border border-yellow-200">
                                                            {comments[day.dateKey]}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ) : (
                                // ì—°ë„ ë³´ê¸° (12ê°œì›” ë¯¸ë‹ˆ ìº˜ë¦°ë”)
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                    {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11].map((m) => {
                                        const miniCal = generateMiniCalendar(year, m);
                                        return (
                                            <div
                                                key={m}
                                                onClick={() => {
                                                    setMonth(m);
                                                    setViewMode('month');
                                                }}
                                                className="bg-white rounded-lg shadow hover:shadow-lg transition cursor-pointer"
                                            >
                                                <div className="bg-[#003D82] text-white text-center font-bold p-2">
                                                    {monthNames[m]}
                                                </div>
                                                <div className="p-2">
                                                    {/* ë¯¸ë‹ˆ ìš”ì¼ í—¤ë” */}
                                                    <div className="grid grid-cols-7 text-xs text-center font-bold mb-1">
                                                        {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((n, i) => (
                                                            <div key={i} className={i === 0 ? 'text-red-500' : ''}>{n}</div>
                                                        ))}
                                                    </div>
                                                    {/* ë¯¸ë‹ˆ ìº˜ë¦°ë” ë‚ ì§œë“¤ */}
                                                    <div className="grid grid-cols-7 gap-px">
                                                        {Array(miniCal.firstDay).fill(0).map((_, i) => (
                                                            <div key={'e' + i} className="text-xs h-8"></div>
                                                        ))}
                                                        {miniCal.days.map((day) => {
                                                            const isNight = day.night;
                                                            const isSunday = day.dow === 0;
                                                            return (
                                                                <div
                                                                    key={day.d}
                                                                    className={`text-xs h-8 flex items-center justify-center rounded ${isNight ? 'bg-[#1e3a5f] text-white' : 'bg-gray-100'
                                                                        } ${isSunday ? 'text-red-500 font-bold' : ''}`}
                                                                >
                                                                    {day.d}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {/* ë©”ëª¨ ì˜ì—­ */}
                        <div className="max-w-7xl mx-auto px-4 pb-4 memo-area">
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-lg p-4 print:shadow-none print:border-t print:mt-4`}>
                                <h3 className={`font-bold mb-2 text-lg ${darkMode ? 'text-cyan-400' : 'text-[#003D82]'}`}>ğŸ“ ë©”ëª¨</h3>
                                <textarea
                                    value={memo}
                                    onChange={(e) => setMemo(e.target.value)}
                                    placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                    className={`w-full border-2 rounded-lg p-3 focus:outline-none ${darkMode
                                        ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400 focus:border-cyan-400'
                                        : 'bg-white border-gray-300 focus:border-[#003D82]'
                                        } print:border-none print:resize-none`}
                                    rows="4"
                                />
                            </div>
                        </div>
                    </div>

                    {/* Day Detail Modal */}
                    {selectedDay && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-md w-full">
                                <div className="bg-[#003D82] text-white p-4 flex justify-between items-center">
                                    <h2 className="text-xl font-bold">
                                        {year}ë…„ {month + 1}ì›” {selectedDay.d}ì¼ ({['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][selectedDay.dow]})
                                    </h2>
                                    <button onClick={() => setSelectedDay(null)} className="text-2xl">âœ•</button>
                                </div>
                                <div className="p-6 space-y-4">
                                    {/* OFF ì„¤ì • - í† ê¸€ UI ê°œì„  */}
                                    <div className="flex items-center justify-between p-4 bg-gray-100 rounded">
                                        <span className="font-bold">íœ´ë¬´ì¼ ì„¤ì •:</span>
                                        <button
                                            onClick={() => {
                                                const isCurrentlyOff = offDays.includes(selectedDay.dateKey);
                                                if (isCurrentlyOff) {
                                                    setOffDays(offDays.filter(d => d !== selectedDay.dateKey));
                                                    setSelectedDay({ ...selectedDay, isOffDay: false });
                                                    showToast(`${month + 1}ì›” ${selectedDay.d}ì¼: ê·¼ë¬´ì¼ë¡œ ë³€ê²½`);
                                                } else {
                                                    setOffDays([...offDays, selectedDay.dateKey]);
                                                    setSelectedDay({ ...selectedDay, isOffDay: true });
                                                    showToast(`${month + 1}ì›” ${selectedDay.d}ì¼: íœ´ë¬´ì¼ë¡œ ë³€ê²½`);
                                                }
                                            }}
                                            className={`px-6 py-3 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-105 ${(offDays.includes(selectedDay.dateKey) || selectedDay.dow === 0)
                                                ? 'bg-red-500 hover:bg-red-600 text-white shadow-lg'
                                                : 'bg-green-500 hover:bg-green-600 text-white shadow-lg'
                                                }`}
                                        >
                                            {(offDays.includes(selectedDay.dateKey) || selectedDay.dow === 0) ? 'ğŸ”´ OFF (íœ´ë¬´)' : 'ğŸŸ¢ ê·¼ë¬´ì¼'}
                                        </button>
                                    </div>

                                    {/* ê·¼ë¬´ì ë³€ê²½ */}
                                    {!selectedDay.isOffDay && selectedDay.dow !== 0 && (
                                        <>
                                            <div className="space-y-2">
                                                <label className="block font-bold text-blue-700">ì „ë°˜ ê·¼ë¬´ì</label>
                                                <select
                                                    value={selectedDay.am}
                                                    onChange={(e) => {
                                                        setOverrides({
                                                            ...overrides,
                                                            [selectedDay.dateKey]: {
                                                                am: e.target.value,
                                                                pm: selectedDay.pm
                                                            }
                                                        });
                                                    }}
                                                    className="w-full border-2 border-gray-300 p-2 rounded"
                                                >
                                                    {allWorkers.map(w => (
                                                        <option key={w} value={w}>{w}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div className="space-y-2">
                                                <label className="block font-bold text-green-600">í›„ë°˜ ê·¼ë¬´ì</label>
                                                <select
                                                    value={selectedDay.pm}
                                                    onChange={(e) => {
                                                        setOverrides({
                                                            ...overrides,
                                                            [selectedDay.dateKey]: {
                                                                am: selectedDay.am,
                                                                pm: e.target.value
                                                            }
                                                        });
                                                    }}
                                                    className="w-full border-2 border-gray-300 p-2 rounded"
                                                >
                                                    {allWorkers.map(w => (
                                                        <option key={w} value={w}>{w}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </>
                                    )}

                                    {/* 7ë²ˆ: í† ìš”ì¼ íŠ¹ê·¼ ì„¤ì • */}
                                    {selectedDay.dow === 6 && (
                                        <div className="flex items-center justify-between p-4 bg-orange-50 rounded border border-orange-200">
                                            <span className="font-bold text-orange-700">ğŸ­ í† ìš”ì¼ ìƒì‚°íŠ¹ê·¼:</span>
                                            <button
                                                onClick={() => {
                                                    const isCurrentlyOvertime = saturdayOvertime[selectedDay.dateKey];
                                                    setSaturdayOvertime({
                                                        ...saturdayOvertime,
                                                        [selectedDay.dateKey]: !isCurrentlyOvertime
                                                    });
                                                    showToast(isCurrentlyOvertime ? 'íŠ¹ê·¼ í•´ì œ' : 'íŠ¹ê·¼ ì„¤ì •');
                                                }}
                                                className={`px-4 py-2 rounded-lg font-bold transition ${saturdayOvertime[selectedDay.dateKey]
                                                    ? 'bg-orange-500 text-white'
                                                    : 'bg-gray-200 text-gray-700'
                                                    }`}
                                            >
                                                {saturdayOvertime[selectedDay.dateKey] ? 'âœ… íŠ¹ê·¼' : 'ë¯¸íŠ¹ê·¼'}
                                            </button>
                                        </div>
                                    )}

                                    {/* 2ë²ˆ/6ë²ˆ: Cì¡° ê°œë³„ ìˆ˜ì • */}
                                    {selectedDay.night && (
                                        <div className="space-y-2 p-4 bg-blue-50 rounded border border-blue-200">
                                            <label className="block font-bold text-blue-700">
                                                {selectedDay.dow === 0 ? 'ğŸŒ… ì¡°ê¸°ê°€ë™ ê·¼ë¬´ì' : 'ğŸŒ™ Cì¡° ê·¼ë¬´ì'} (ì§ì ‘ ì…ë ¥)
                                            </label>
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    placeholder="ì˜ˆ: ë¯¼ì„±, ê´‘ìˆ˜, ì´ì§„"
                                                    value={nightTeamOverrides[selectedDay.dateKey] || ''}
                                                    onChange={(e) => {
                                                        setNightTeamOverrides({
                                                            ...nightTeamOverrides,
                                                            [selectedDay.dateKey]: e.target.value
                                                        });
                                                    }}
                                                    className="flex-1 border-2 border-blue-300 p-2 rounded-lg focus:border-blue-500 outline-none"
                                                />
                                                <button
                                                    onClick={() => {
                                                        const newOverrides = { ...nightTeamOverrides };
                                                        delete newOverrides[selectedDay.dateKey];
                                                        setNightTeamOverrides(newOverrides);
                                                        showToast('Cì¡° ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›');
                                                    }}
                                                    className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-bold"
                                                >
                                                    ì‚­ì œ
                                                </button>
                                            </div>
                                            <p className="text-xs text-gray-500">ë¹„ì›Œë‘ë©´ ê¸°ë³¸ Cì¡°({nightTeams[selectedNightTeam].join(', ')})ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                        </div>
                                    )}

                                    {/* ì½”ë©˜íŠ¸ ì…ë ¥ */}
                                    <div className="space-y-2 mt-4">
                                        <label className="block font-bold text-gray-700">ë©”ëª¨ / íŠ¹ì´ì‚¬í•­</label>
                                        <input
                                            type="text"
                                            placeholder="ì˜ˆ: ì„ê°€íƒ„ì‹ ì¼, ì°½ë¦½ê¸°ë…ì¼ ë“±"
                                            value={comments[selectedDay.dateKey] || ''}
                                            onChange={(e) => {
                                                setComments({
                                                    ...comments,
                                                    [selectedDay.dateKey]: e.target.value
                                                });
                                            }}
                                            className="w-full border-2 border-gray-300 p-3 rounded-lg focus:border-blue-500 outline-none transition"
                                        />
                                    </div>

                                    <div className="flex gap-2 mt-6">
                                        <button
                                            onClick={() => setSelectedDay(null)}
                                            className="flex-1 bg-[#003D82] text-white py-3 rounded-lg font-bold hover:bg-[#002555]"
                                        >
                                            âœ“ í™•ì¸
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="bg-[#003D82] text-white p-4 flex justify-between items-center">
                                    <h2 className="text-xl font-bold">âš™ï¸ ì„¤ì •</h2>
                                    <button onClick={() => setShowSettings(false)} className="text-2xl">âœ•</button>
                                </div>
                                <div className="p-6">
                                    <h3 className="text-lg font-bold mb-4">íŒ€ë³„ ê·¼ë¬´ì</h3>
                                    {Object.entries(teams).map(([teamName, members]) => (
                                        <div key={teamName} className="mb-6 p-4 border-2 border-gray-300 rounded-lg">
                                            <div className="font-bold text-[#003D82] mb-3 text-lg">
                                                {teamName} ({members.length}ëª…)
                                            </div>

                                            {/* ê·¼ë¬´ì ëª©ë¡ */}
                                            <div className="space-y-2 mb-3">
                                                {members.map((member, idx) => (
                                                    <div key={idx} className="flex items-center gap-2">
                                                        <input
                                                            type="text"
                                                            value={member}
                                                            onChange={(e) => {
                                                                const newMembers = [...members];
                                                                newMembers[idx] = e.target.value;
                                                                setTeams({ ...teams, [teamName]: newMembers });
                                                            }}
                                                            className="flex-1 border-2 border-gray-300 px-3 py-2 rounded"
                                                        />
                                                        <button
                                                            onClick={() => {
                                                                const newMembers = members.filter((_, i) => i !== idx);
                                                                setTeams({ ...teams, [teamName]: newMembers });
                                                            }}
                                                            className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded font-bold"
                                                        >
                                                            ì‚­ì œ
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* ì¶”ê°€ ë²„íŠ¼ */}
                                            <button
                                                onClick={() => {
                                                    const newName = prompt('ì¶”ê°€í•  ê·¼ë¬´ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
                                                    if (newName && newName.trim()) {
                                                        setTeams({ ...teams, [teamName]: [...members, newName.trim()] });
                                                    }
                                                }}
                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-bold"
                                            >
                                                + ê·¼ë¬´ì ì¶”ê°€
                                            </button>
                                        </div>
                                    ))}

                                    <h3 className="text-lg font-bold mb-4 mt-6">ì•¼ê°„ Cì¡° íŒ€</h3>
                                    {Object.entries(nightTeams).map(([teamName, members]) => (
                                        <div key={teamName} className="mb-4 p-4 border-2 border-gray-300 rounded-lg">
                                            <div className="font-bold text-[#003D82] mb-3">
                                                {teamName} ({members.length}ëª…)
                                            </div>

                                            {/* Cì¡° ê·¼ë¬´ì ëª©ë¡ */}
                                            <div className="space-y-2 mb-3">
                                                {members.map((member, idx) => (
                                                    <div key={idx} className="flex items-center gap-2">
                                                        <input
                                                            type="text"
                                                            value={member}
                                                            onChange={(e) => {
                                                                const newMembers = [...members];
                                                                newMembers[idx] = e.target.value;
                                                                setNightTeams({ ...nightTeams, [teamName]: newMembers });
                                                            }}
                                                            className="flex-1 border-2 border-gray-300 px-3 py-2 rounded"
                                                        />
                                                        <button
                                                            onClick={() => {
                                                                const newMembers = members.filter((_, i) => i !== idx);
                                                                setNightTeams({ ...nightTeams, [teamName]: newMembers });
                                                            }}
                                                            className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded font-bold"
                                                        >
                                                            ì‚­ì œ
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Cì¡° ì¶”ê°€ ë²„íŠ¼ */}
                                            <button
                                                onClick={() => {
                                                    const newName = prompt('ì¶”ê°€í•  ê·¼ë¬´ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
                                                    if (newName && newName.trim()) {
                                                        setNightTeams({ ...nightTeams, [teamName]: [...members, newName.trim()] });
                                                    }
                                                }}
                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-bold text-sm"
                                            >
                                                + ê·¼ë¬´ì ì¶”ê°€
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                {/* ë‚´íŒì‹¤ëŸ¬ ë¡œí…Œì´ì…˜ ì„¤ì • */}
                                <div className="p-6 border-t-2 border-gray-100">
                                    <h3 className="text-lg font-bold mb-4 text-[#003D82]">ğŸ”„ ë‚´íŒì‹¤ëŸ¬ ì•ˆì°©ë¶ˆëŸ‰ ì¡°ì¹˜ ë¡œí…Œì´ì…˜</h3>
                                    <div className="bg-blue-50 p-4 rounded-lg space-y-4">
                                        <div className="flex flex-col gap-2">
                                            <label className="font-bold text-gray-700 text-sm">ë¡œí…Œì´ì…˜ ì‹œì‘ ê¸°ì¤€ì¼ (ì»¨ë² ì–´íŒ€ ì‹œì‘ì¼):</label>
                                            <input
                                                type="date"
                                                value={sealerRotationDate}
                                                onChange={(e) => setSealerRotationDate(e.target.value)}
                                                className="border-2 border-gray-300 p-2 rounded-lg focus:border-blue-500 outline-none w-full max-w-xs text-black"
                                            />
                                        </div>
                                        <div className="text-sm text-gray-600 space-y-1">
                                            <p>â€¢ 2ì£¼(14ì¼) ê°„ê²©ìœ¼ë¡œ íŒ€ì´ ìë™ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
                                            <p>â€¢ ìˆœì„œ: <strong>ì»¨ë² ì–´íŒ€ â†’ ë¡œë³´íŠ¸íŒ€ â†’ ì£¼ì„¤ë¹„íŒ€</strong></p>
                                        </div>
                                    </div>
                                </div>

                                {/* í…Œë§ˆ ì„¤ì • */}
                                <div className="p-6 border-t-2 border-gray-100">
                                    <h3 className="text-lg font-bold mb-4" style={{ color: themeColor }}>ğŸ¨ í…Œë§ˆ ìƒ‰ìƒ</h3>
                                    <div className="flex items-center gap-2 flex-wrap mb-4">
                                        {['#003D82', '#1e40af', '#059669', '#dc2626', '#7c3aed', '#ea580c', '#0891b2', '#be185d'].map(color => (
                                            <button key={color} onClick={() => { setThemeColor(color); addHistory(`í…Œë§ˆ: ${color}`); }} style={{ backgroundColor: color }} className={`w-10 h-10 rounded-lg border-2 ${themeColor === color ? 'border-white ring-2 ring-offset-2 ring-gray-400' : 'border-transparent'} hover:scale-110 transition`} />
                                        ))}
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <label className="font-bold text-gray-700">ì§ì ‘ ì„ íƒ:</label>
                                        <input type="color" value={themeColor} onChange={(e) => { setThemeColor(e.target.value); addHistory(`í…Œë§ˆ: ${e.target.value}`); }} className="w-12 h-10 rounded cursor-pointer border-2 border-gray-300" />
                                        <button onClick={() => setThemeColor('#003D82')} className="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded text-sm font-bold">ê¸°ë³¸</button>
                                    </div>
                                </div>

                                {/* íœ´ê°€ ê´€ë¦¬ */}
                                <div className="p-6 border-t-2 border-gray-100">
                                    <h3 className="text-lg font-bold mb-4" style={{ color: themeColor }}>ğŸ–ï¸ íœ´ê°€ ê´€ë¦¬</h3>
                                    <div className="flex gap-2 flex-wrap mb-4">
                                        <select id="vw" className="border-2 border-gray-300 p-2 rounded-lg">{allWorkers.map(w => <option key={w} value={w}>{w}</option>)}</select>
                                        <input type="date" id="vd" className="border-2 border-gray-300 p-2 rounded-lg" />
                                        <button onClick={() => { const w = document.getElementById('vw').value, d = document.getElementById('vd').value; if (w && d) { setVacations(p => ({ ...p, [w]: [...(p[w] || []), d] })); showToast(`${w} íœ´ê°€: ${d}`); addHistory(`${w} íœ´ê°€: ${d}`); } }} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold">+ ë“±ë¡</button>
                                    </div>
                                    {Object.entries(vacations).filter(([, d]) => d.length > 0).map(([w, d]) => <div key={w} className="bg-yellow-50 p-2 rounded border border-yellow-200 mb-2 flex justify-between"><span><b className="text-yellow-700">{w}:</b> {d.join(', ')}</span><button onClick={() => setVacations(p => ({ ...p, [w]: [] }))} className="text-red-500 text-sm">ì‚­ì œ</button></div>)}
                                </div>

                            </div>
                        </div>
                    )}

                    {/* Stats Modal */}
                    {showStats && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                <div style={{ backgroundColor: themeColor }} className="text-white p-4 flex justify-between items-center">
                                    <h2 className="text-xl font-bold">ğŸ“Š ê·¼ë¬´ í†µê³„ - {year}ë…„ {monthNames[month]}</h2>
                                    <button onClick={() => setShowStats(false)} className="text-2xl">âœ•</button>
                                </div>
                                <div className="p-6">
                                    <div className="overflow-x-auto">
                                        <table className="w-full border-collapse">
                                            <thead>
                                                <tr className="bg-gray-100">
                                                    <th className="border border-gray-300 px-4 py-2 text-left">ê·¼ë¬´ì</th>
                                                    <th className="border border-gray-300 px-4 py-2 text-center">ì´ ê·¼ë¬´ì¼</th>
                                                    <th className="border border-gray-300 px-4 py-2 text-center">ì „ë°˜</th>
                                                    <th className="border border-gray-300 px-4 py-2 text-center">í›„ë°˜</th>
                                                    <th className="border border-gray-300 px-4 py-2 text-center">ì£¼ê°„</th>
                                                    <th className="border border-gray-300 px-4 py-2 text-center">ì•¼ê°„</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {allWorkers.map(worker => {
                                                    const stat = calculateStats[worker];
                                                    return (
                                                        <tr key={worker} className="hover:bg-gray-50">
                                                            <td className="border border-gray-300 px-4 py-2 font-semibold">{worker}</td>
                                                            <td className="border border-gray-300 px-4 py-2 text-center font-bold text-lg">{stat.total}</td>
                                                            <td className="border border-gray-300 px-4 py-2 text-center text-blue-700">{stat.am}</td>
                                                            <td className="border border-gray-300 px-4 py-2 text-center text-green-600">{stat.pm}</td>
                                                            <td className="border border-gray-300 px-4 py-2 text-center text-yellow-600">{stat.dayShift}</td>
                                                            <td className="border border-gray-300 px-4 py-2 text-center text-indigo-600">{stat.nightShift}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                            <tfoot>
                                                <tr className="bg-gray-200 font-bold">
                                                    <td className="border border-gray-300 px-4 py-2">í•©ê³„</td>
                                                    <td className="border border-gray-300 px-4 py-2 text-center">
                                                        {Object.values(calculateStats).reduce((sum, stat) => sum + stat.total, 0)}
                                                    </td>
                                                    <td className="border border-gray-300 px-4 py-2 text-center text-blue-700">
                                                        {Object.values(calculateStats).reduce((sum, stat) => sum + stat.am, 0)}
                                                    </td>
                                                    <td className="border border-gray-300 px-4 py-2 text-center text-green-600">
                                                        {Object.values(calculateStats).reduce((sum, stat) => sum + stat.pm, 0)}
                                                    </td>
                                                    <td className="border border-gray-300 px-4 py-2 text-center text-yellow-600">
                                                        {Object.values(calculateStats).reduce((sum, stat) => sum + stat.dayShift, 0)}
                                                    </td>
                                                    <td className="border border-gray-300 px-4 py-2 text-center text-indigo-600">
                                                        {Object.values(calculateStats).reduce((sum, stat) => sum + stat.nightShift, 0)}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* History Modal */}
                    {showHistory && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-lg w-full max-h-[80vh] overflow-y-auto">
                                <div style={{ backgroundColor: themeColor }} className="text-white p-4 flex justify-between items-center">
                                    <h2 className="text-xl font-bold">ğŸ“œ ë³€ê²½ ì´ë ¥</h2>
                                    <button onClick={() => setShowHistory(false)} className="text-2xl">âœ•</button>
                                </div>
                                <div className="p-4">
                                    {history.length === 0 ? (
                                        <p className="text-gray-500 text-center py-8">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {history.map((entry, idx) => (
                                                <div key={idx} className="bg-gray-50 p-3 rounded-lg border">
                                                    <div className="text-xs text-gray-400">{new Date(entry.time).toLocaleString()}</div>
                                                    <div className="text-sm text-gray-700">{entry.action}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast Container */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-md px-4">
                        {toasts.map(toast => (
                            <div
                                key={toast.id}
                                className={`px-6 py-3 rounded-xl shadow-2xl text-white font-bold animate-toast pointer-events-auto text-center ${toast.type === 'error' ? 'bg-red-500' : 'bg-[#003D82] border border-cyan-400'
                                    }`}
                            >
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>